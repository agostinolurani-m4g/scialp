{% extends 'base.html' %}

{% block extra_head %}
  <link
    rel="stylesheet"
    href="{{ url_for('scialpi.static', filename='vendor/leaflet/leaflet.css') }}"
  />
  <style>
    #avalanche-map { height: 100%; width: 100%; border-radius: 12px; overflow: hidden; }
    .panel-title { font-size: 1rem; font-weight: 600; margin-bottom: 12px; }
    .panel-compact { padding: 12px; }
    .panel-compact .form-label { font-size: 0.82rem; color: var(--muted); margin-bottom: 4px; }
    .panel-compact .form-control,
    .panel-compact .form-select { font-size: 0.85rem; padding: 6px 10px; }
    .filter-toggle { display: flex; align-items: center; justify-content: space-between; }
    .filter-panel { border: 1px solid var(--border); background: var(--accent-soft); }
    .page-title { font-size: 1.4rem; margin-bottom: 4px; }
    .page-subtitle { font-size: 0.9rem; margin-bottom: 12px; }
    .map-layout { min-height: 640px; }
    .side-scroll { padding-right: 6px; }
    .side-stack { display: flex; flex-direction: column; gap: 12px; }
    .side-scroll::-webkit-scrollbar { width: 6px; }
    .side-scroll::-webkit-scrollbar-thumb { background: var(--accent-soft); border-radius: 6px; }
    .map-column { display: flex; flex-direction: column; gap: 10px; }
    .map-toolbar { display: flex; align-items: center; justify-content: space-between; }
    .map-toolbar .btn-group .btn { font-size: 0.82rem; padding: 4px 10px; }
    .map-view { flex: 1; min-height: 520px; }
    .map-footer-line { height: 1px; background: var(--border); border-radius: 2px; }
    .status-note { font-size: 0.82rem; color: var(--muted); }
  </style>
{% endblock %}

{% block content %}
  <div class="avalanche-page">
    <h1 class="title-dynamic page-title">Segnalazioni di valanghe</h1>
    <p class="page-subtitle">Fai clic sulla mappa per segnalare una nuova valanga. Fai clic su un marcatore esistente per confermarla.</p>
    <div class="row g-3 map-layout">
      <div class="col-lg-3 h-100">
        <div class="side-scroll">
          <div class="side-stack">
            <div class="panel-card panel-compact">
              <div class="filter-toggle">
                <div class="panel-title mb-0">Filtri</div>
                <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#avalanche-filters" aria-expanded="true" aria-controls="avalanche-filters">
                  <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path d="M3 5h18M6 12h12M10 19h4" stroke="var(--accent)" stroke-width="2" fill="none" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
              <div class="collapse show" id="avalanche-filters">
                <form class="row g-2 mt-2" id="filter-form">
                  <div class="col-12">
                    <label for="start-date" class="form-label">Da (data)</label>
                    <input type="date" class="form-control" id="start-date" />
                  </div>
                  <div class="col-12">
                    <label for="end-date" class="form-label">A (data)</label>
                    <input type="date" class="form-control" id="end-date" />
                  </div>
                  <div class="col-12 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary w-100" id="range-1-day">1 giorno</button>
                    <button type="button" class="btn btn-outline-primary w-100" id="range-3-days">3 giorni</button>
                  </div>
                  <div class="col-12">
                    <button id="apply-filter" class="btn btn-primary w-100">Filtra</button>
                  </div>
                </form>
              </div>
            </div>

            <div class="panel-card panel-compact">
              <div class="panel-title">Storico</div>
              <div class="status-note">Heatmap delle valanghe in arrivo.</div>
              <button type="button" class="btn btn-outline-secondary w-100 mt-2" id="view-history">Apri storico</button>
              <div class="status-note mt-2" id="history-note"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-6 h-100">
        <div class="map-column">
          <div class="map-toolbar">
            <div class="panel-title mb-0">Mappa</div>
            <div class="btn-group" role="group" aria-label="Seleziona vista">
              <button type="button" class="btn btn-primary">Mappa</button>
              <button type="button" class="btn btn-outline-primary" id="view-history-top">Storico</button>
            </div>
          </div>
          <div id="avalanche-map" class="map-view"></div>
          <div class="map-footer-line"></div>
        </div>
      </div>

      <div class="col-lg-3 h-100">
        <div class="side-scroll">
          <div class="side-stack">
            <div class="panel-card panel-compact">
              <div class="panel-title">Nuova segnalazione</div>
              <form class="row g-3" id="avalanche-form">
                <div class="col-6">
                  <label for="lat" class="form-label">Latitudine</label>
                  <input type="text" class="form-control" id="lat" name="lat" readonly />
                </div>
                <div class="col-6">
                  <label for="lon" class="form-label">Longitudine</label>
                  <input type="text" class="form-control" id="lon" name="lon" readonly />
                </div>
                <div class="col-12">
                  <label for="description" class="form-label">Descrizione</label>
                  <input type="text" class="form-control" id="description" name="description" />
                </div>
                <div class="col-6">
                  <label for="size" class="form-label">Dimensione</label>
                  <select class="form-select" id="size" name="size">
                    <option value="">--</option>
                    <option value="small">Piccola</option>
                    <option value="medium">Media</option>
                    <option value="large">Grande</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="danger" class="form-label">Pericolo (1-5)</label>
                  <select class="form-select" id="danger" name="danger">
                    <option value="">--</option>
                    {% for i in range(1,6) %}
                    <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-6">
                  <label for="slope" class="form-label">Pendenza (A deg)</label>
                  <input type="number" class="form-control" id="slope" name="slope" min="0" max="90" />
                </div>
                <div class="col-6">
                  <label for="image" class="form-label">Immagine</label>
                  <input type="file" class="form-control" id="image" name="image" accept="image/*" />
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-success w-100">Salva segnalazione</button>
                  <span class="ms-2 text-muted" id="avalanche-status"></span>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
  <script src="{{ url_for('scialpi.static', filename='vendor/leaflet/leaflet.js') }}"></script>
  <!-- Il file JS e' fornito dalla blueprint 'scialpi', non dall'app globale -->
  <script src="{{ url_for('scialpi.static', filename='js/avalanches.js') }}"></script>
{% endblock %}
